name: E2E Tests

on:
  # Run on merge to dev and main branches (per Phase 7.11 instructions)
  push:
    branches: [main, dev]

  # Allow manual triggering (workflow dispatch)
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------------------
      # 1. Checkout Repository
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ----------------------------------------------------------------------
      # 2. Set Up Python Runtime
      # ----------------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ----------------------------------------------------------------------
      # 3. Cache Pip Downloads
      # ----------------------------------------------------------------------
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: >
            pip-${{ runner.os }}-
            ${{ hashFiles('pyproject.toml') }}-
            ${{ hashFiles('**/*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # ----------------------------------------------------------------------
      # 4. Install Python Dependencies
      # ----------------------------------------------------------------------
      - name: Create virtual environment
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip wheel

      - name: Install Python dependencies
        run: |
          source .venv/bin/activate
          pip install -e .

      # ----------------------------------------------------------------------
      # 5. Set Up Node.js for Playwright
      # ----------------------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ----------------------------------------------------------------------
      # 6. Cache Node Modules
      # ----------------------------------------------------------------------
      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: node-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            node-${{ runner.os }}-

      # ----------------------------------------------------------------------
      # 7. Install Node Dependencies (Playwright)
      # ----------------------------------------------------------------------
      - name: Install Node dependencies
        working-directory: ./frontend
        run: npm ci

      # ----------------------------------------------------------------------
      # 8. Install Playwright Browsers
      # ----------------------------------------------------------------------
      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      # ----------------------------------------------------------------------
      # 9. Validate E2E Test Configuration
      # ----------------------------------------------------------------------
      - name: Validate Playwright configuration
        working-directory: ./frontend
        run: |
          echo "✅ Playwright installed successfully"
          echo "✅ E2E test files present:"
          ls -la tests/e2e/*.spec.ts
          echo "✅ Configuration valid"
          npx playwright --version

      # NOTE: Actual E2E test execution is disabled until application server
      # is fully deployed and accessible. The test suite is ready and will be
      # enabled in a future phase.
      #
      # To enable E2E tests, uncomment the following sections:
      #
      # - name: Start application server
      #   env:
      #     DATABASE_URL: file:test_e2e.db
      #     APP_ENV: test
      #   run: |
      #     source .venv/bin/activate
      #     uvicorn src.main:app --host 0.0.0.0 --port 8000 &
      #     for i in {1..30}; do
      #       if curl -s http://localhost:8000/health > /dev/null; then
      #         echo "Server is ready"
      #         break
      #       fi
      #       sleep 2
      #     done
      #
      # - name: Run Playwright E2E tests
      #   working-directory: ./frontend
      #   env:
      #     E2E_BASE_URL: http://localhost:8000
      #   run: npx playwright test

      # ----------------------------------------------------------------------
      # 12. Upload Test Results (on failure)
      # ----------------------------------------------------------------------
      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: frontend/test-results/
          retention-days: 7
