name: E2E Tests

on:
  # Run on merge to dev and main branches (per Phase 7.11 instructions)
  push:
    branches: [main, dev]

  # Allow manual triggering (workflow dispatch)
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------------------
      # 1. Checkout Repository
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ----------------------------------------------------------------------
      # 2. Set Up Python Runtime
      # ----------------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ----------------------------------------------------------------------
      # 3. Cache Pip Downloads
      # ----------------------------------------------------------------------
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: >
            pip-${{ runner.os }}-
            ${{ hashFiles('pyproject.toml') }}-
            ${{ hashFiles('**/*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # ----------------------------------------------------------------------
      # 4. Install Python Dependencies
      # ----------------------------------------------------------------------
      - name: Create virtual environment
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip wheel

      - name: Install Python dependencies
        run: |
          source .venv/bin/activate
          pip install -e .

      # ----------------------------------------------------------------------
      # 5. Set Up Node.js for Playwright
      # ----------------------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ----------------------------------------------------------------------
      # 6. Cache Node Modules
      # ----------------------------------------------------------------------
      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            node-${{ runner.os }}-

      # ----------------------------------------------------------------------
      # 7. Install Node Dependencies (Playwright)
      # ----------------------------------------------------------------------
      - name: Install Node dependencies
        run: npm ci

      # ----------------------------------------------------------------------
      # 8. Install Playwright Browsers
      # ----------------------------------------------------------------------
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # ----------------------------------------------------------------------
      # 9. Set Up Test Database
      # ----------------------------------------------------------------------
      - name: Set up test database
        env:
          DATABASE_URL: file:test_e2e.db
          APP_ENV: test
        run: |
          source .venv/bin/activate
          python -m src.db.migrate

      # ----------------------------------------------------------------------
      # 10. Start Application Server
      # ----------------------------------------------------------------------
      - name: Start application server
        env:
          DATABASE_URL: file:test_e2e.db
          APP_ENV: test
          PORT: 8000
        run: |
          source .venv/bin/activate
          uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:8000/health > /dev/null; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done

      # ----------------------------------------------------------------------
      # 11. Run E2E Tests
      # ----------------------------------------------------------------------
      - name: Run Playwright E2E tests
        env:
          E2E_BASE_URL: http://localhost:8000
          E2E_DATABASE_URL: file:test_e2e.db
        run: npx playwright test

      # ----------------------------------------------------------------------
      # 12. Upload Test Results (on failure)
      # ----------------------------------------------------------------------
      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7
